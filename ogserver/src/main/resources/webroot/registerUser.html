<html>
<head>
    <script type="text/javascript" src="/js/libs/jquery/dist/jquery.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/3.4.0/firebase.js"></script>
    <script>
     // Initialize Firebase
     var config = {
       apiKey: "AIzaSyCoKs1sqeE8GmMKysYpkOdO9KkZXcmhDQ0",
       authDomain: "mygubbi-uat.firebaseapp.com",
       databaseURL: "https://mygubbi-uat.firebaseio.com",
       storageBucket: "mygubbi-uat.appspot.com",
       messagingSenderId: "106892346704"
     };
     firebase.initializeApp(config);
    </script>
</head>
<body>
    <h1 id="test"></h1>
    <div id="testdv"></div>
    <script>
        $(document).ready(function() {
            var path = $(location).attr('href');

            var vars = [], hash;
            var q = document.URL.split('?')[1];
            if(q != undefined){
                q = q.split('&');
                for(var i = 0; i < q.length; i++){
                    hash = q[i].split('=');
                    vars.push(hash[1]);
                    vars[hash[0]] = hash[1];
                }
            }

            var name = vars['name'];
            var email = decodeURIComponent(vars['email']);
            var phone = decodeURIComponent(vars['phone']);
            var password = vars['password'];

            var photoURL = vars['photoURL'] ? vars['photoURL']: 'https://res.cloudinary.com/mygubbi/image/upload/f_auto/user.png';
            var crmId = vars['crmId'];
            var proposal = vars['proposal'];

            console.log(photoURL);

            firebase.auth().createUserWithEmailAndPassword(email, password).then(function(userData) {
                console.log("Successfully created user account with uid:", userData.uid);
                $("#testdv").text("Successfully created user account with uid:" + userData.uid);

                var uid = userData.uid;
                /*firebase.auth().signOut().then(function() {
                      console.log("Sign-out successful");
                      $("#testdv").text("Sign-out successful");
                }, function(error) {
                  console.log("An error happened");
                  $("#testdv").text("An error happened");
                });*/


                console.log("uid: "+uid);
                $("#testdv").text("uid: "+uid);

                var userData = {
                    providerData: "password",
                    email: email,
                    displayName: name,
                    profileImage: photoURL,
                    uid: uid
                };
                 createUser(userData);
                 var profileData = {
                    displayName: name,
                    email: email,
                    phone: phone,
                    profileImage: photoURL,
                    crmId:crmId
                };
                createProfile(userData,profileData);
            }, function(error) {
                // An error happened.
                console.log("Error creating user:", error);
                $("#testdv").text("Error creating user:" + error);
            });

        });
        function createUser(userData){
            firebase.database().ref().child("users").child(userData.uid).set(userData, function(error) {
                if (error) {
                    console.log("Data could not be saved." + error);
                    $("#testdv").text("Data could not be saved." + error);
                } else {
                    console.log("Data saved successfully.");
                    $("#testdv").text("Data saved successfully.");
                }
            });
        }
        function createProfile(userData,profileData){

            firebase.database().ref().child('user-profiles').child(userData.uid).set(
                profileData,
                function(error) {
                    if (error) {
                        console.log("password profile data could not be saved." + error);
                        $("#testdv").text("password profile data could not be saved." + error);
                    } else {
                        console.log("data saved successfully.");
                        $("#testdv").text("data saved successfully.");
                    }
                }
            );
            pushEvent(userData.uid, profileData, "user.add");
        }
        function pushEvent(uid, data, type){
            var eventData = {
                "data": data,
                "type": type
            };
            firebase.database().ref().child("events").push().child(uid).set(eventData, function(error) {
                if (error) {
                    console.log("not able to push event data", error);
                    $("#testdv").text("not able to push event data" + error);
                } else {
                    console.log("successfully pushed event data");
                    $("#testdv").text("successfully pushed event data");

                }
            });
        }
    </script>
</body>
</html>