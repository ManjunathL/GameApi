<nav class="navbar navbar-default navbar-shrink navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <div class="navbar-brand page-scroll padding0">
                <a href="#">
                    <img src="img/logos/logo.png" class="full_logo" alt="">
                    <img
                            src="img/logo_icon/48x48.png"
                            class="small_logo"
                            data-toggle="collapse"
                            data-target="#bs-example-navbar-collapse-1"
                            alt="">
                </a>
            </div>
            <div class="nav navbar-nav navbar-right menu-icon float-right font-size18 margin0">
                <a href="#" class="consult">Consult</a>
                <span class="padding10 consult_icon">
                    <a href="#">
                        <img src="/img/query.png" class="consult_icon_height">
                    </a>
                </span>
                <span class="glyphicon glyphicon-search search"></span>

                <% if(typeof(usersl) !== 'undefined' && ((Object.keys(usersl).length - 1) !== 0)) { %>
                <span class="glyphicon glyphicon-heart wishlist user" id="wish">
                    <span class="super-script"><%= Object.keys(usersl).length - 1 %></span>
                </span>
                <% } else { %>
                <span class="glyphicon glyphicon-heart-empty wishlist user"></span>
                <% } %>

                <% if (users.length > 0 && users.at(0).get('profileImage')) { %>
                    <span class="user user-img"
                          style="background-image:url('<%= users.at(0).get('profileImage') %>')"></span>
                <% }else { %>
                    <span class="glyphicon glyphicon-user user" id="user-icon" data-loading-text="<i class='fa fa-spinner fa-spin'></i>"></span>
                <% } %>

            </div>

        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav menu-right">
                <li>
                    <a
                            class="dropdown-toggle"
                            id="dropdownMenu_livndin"
                            data-toggle="dropdown"
                            aria-haspopup="true"
                            aria-expanded="true">
                        Living & Dining
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu drop" aria-labelledby="dropdownMenu">

                        <li><a href="#products/livingndining/entunit">Entertainment Unit</a></li>

                        <li><a href="#products/livingndining/shoerack">Shoe Rack</a></li>

                        <li><a href="#products/livingndining/crockunit">Crockery Unit</a></li>

                        <li class="all">
                            <hr class="allhr"/>
                            <a href="#products/livingndining">ALL</a>
                        </li>

                    </ul>
                </li>
                <li>
                    <a
                            class="dropdown-toggle"
                            id="dropdownMenu_kitchen"
                            data-toggle="dropdown"
                            aria-haspopup="true"
                            aria-expanded="true">
                        Kitchen
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu drop" aria-labelledby="dropdownMenu">

                        <li><a href="#products/kitchen/lshapedk">L Shaped Kitchen</a></li>

                        <li><a href="#products/kitchen/ushapedk">U Shaped Kitchen</a></li>

                        <li><a href="#products/kitchen/straightk">Straight Kitchen</a></li>

                        <li><a href="#products/kitchen/parallelk">Parallel Kitchen</a></li>

                        <li class="all">
                            <hr class="allhr"/>
                            <a href="#products/kitchen">ALL</a>
                        </li>

                    </ul>
                </li>
                <li>
                    <a
                            class="dropdown-toggle"
                            id="dropdownMenu_bedroom"
                            data-toggle="dropdown"
                            aria-haspopup="true"
                            aria-expanded="true">
                        Bedroom
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu drop" aria-labelledby="dropdownMenu">

                        <li><a href="#products/bedroom/wardrobe">Wardrobe</a></li>

                        <li><a href="#products/bedroom/studytable">Study Table</a></li>

                        <li><a href="#products/bedroom/sidetable">Side Table</a></li>

                        <li><a href="#products/bedroom/bookrack">Book Rack</a></li>

                        <li class="all">
                            <hr class="allhr"/>
                            <a href="#products/bedroom">ALL</a>
                        </li>

                    </ul>
                </li>

                <li>
                    <a href="#">Stories</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container-fluid -->
</nav>
<!-- Navigation End -->

<!-- User PopUp -->
<div class="userpop">
    <div class="userpop-content">
        <% if (users.length > 0) { %>
        <h3>
            <% if (users.at(0).get('profileImage')) { %>
                <img src="<%= users.at(0).get('profileImage') %>">
            <% }else { %>
                <img src="img/user.png">
            <% } %>
            <%= users.at(0).get('displayName') %>
            <div class="sub-font">
                <a href="/#user_profile">
                    View Profile
                </a>
            </div>
            <span class="fa fa-sign-out signout_icon"
                  data-toggle="tooltip"
                  data-placement="left"
                  title="Sign Out" onclick="signOut();">

            </span>
        </h3>
        <div class="row">
            <div class="col-md-8 col-xs-8 padding0">
                <h4>Items Shortlisted</h4>
            </div>
            <div class="col-md-4 col-xs-4 padding0 align-right">
                <a href="#" class="button-orange">view all</a>
            </div>
        </div>
        <div class="row shortlist">
            <div class="col-md-12 padding0">
                <% if(typeof(usersl) !== 'undefined' && ((Object.keys(usersl).length - 1) !== 0)) {
                    var count = 0;
                _.each(usersl, function(sl){
                if(typeof(sl.name) !== 'undefined'){ %>
                <div class="margin-top20 padding-bottom10">
                    <%= ++count + ". " + sl.name %>
                </div>
                <div class="row">
                    <div class="col-md-7 padding0">
                        <img src="<%= imgBase + 'c_fill/' + sl.image %>" class="shortlist-thumb">
                    </div>
                    <div class="col-md-5">
                        <% if((sl.price > 100) && (sl.price !== 'NULL') && (typeof(sl.price) !== 'undefined')) { %>
                        &#8377; <%= " " + sl.price %>
                        <% } else {%>
                        <a href="#" class="font-size12 available">Available for Consultation</a>
                        <% } %>
                        <span class="button shortlist-remove">remove</span>
                    </div>
                </div>
                <% } }); } else { %>
                <div class="margin-top20">
                    <div class="row padding10">
                        <span>Oops! No items in your wishlist...</span>
                    </div>
                    <div class="row padding10">
                        <span>Explore our wide range of furniture & decor items.</span>
                    </div>
                    <div class="row padding10">
                        <span>And save them for your quick reference in future...</span>
                    </div>
                    <div class="row padding10 align-center">
                        <span class="button">Explore...</span>
                    </div>
                </div>
                <% } %>
            </div>
        </div>

        <% } else { %>
        <h2>
            <img src="img/user.png">
            My Account
        </h2>

        <form id="loginForm" data-toggle="validator" role="form">
            <div class="row display-none" id="login_error_row">
                <p class="margin0 error-text align-center" id="login_error"></p>
            </div>

            <div class="row">
                <div class="margin-bottom20 form-group">
                    <p class="margin0">Email ID*</p>
                    <input type="email" class="width100" placeholder="abc@xyz.com" id="emailId" maxlength="100"
                           style="color: #000;" required pattern=".+@.+\..+" title="<abc>@<xyz>.<com>"/>
                </div>
                <div class="margin-bottom20 form-group">
                    <p class="margin0">Password*</p>
                    <input type="password" class="width100" id="pwd" required maxlength="100"/>
                </div>
                <div>
                    <input type="checkbox" id="remember" checked/> Remember Me
                </div>
                <div class="padding20-0">
                    <div class="col-md-6 col-xs-6 padding0 form-group margin0">
                        <button id="loginBtn" class="button margin-top20 margin-bottom20" style="background: transparent"
                                type="submit" data-loading-text="<i class='fa fa-spinner fa-spin'></i> sign in">sign in
                        </button>
                    </div>
                    <div class="col-md-6 col-xs-6 padding0 align-right">
                        <a href="#">Forgot Password??</a>
                        <!--a
                                href="#"
                                data-toggle="modal"
                                data-target="#forgot_password">
                            Forgot Password??
                        </a-->
                    </div>
                </div>
            </div>
        </form>

        <div class="row margin-top20 margin-bottom20">
            <p class="align-center">OR</p>

            <div class="margin-bottom40">
                <p>
                    Use your favourite social account
                </p>
                <ul class="list-inline social-buttons align-center">
                    <li>
                        <a href="#" id="fb-btn" data-loading-text="<i class='fa fa-spinner fa-spin'></i>"><i class="fa fa-facebook"></i></a>
                    </li>
                    <li>
                        <a href="#" id="google-btn" data-loading-text="<i class='fa fa-spinner fa-spin'></i>"><i class="fa fa-google"></i></a>
                    </li>
                </ul>
            </div>
            <div class="margin-bottom20">
                <p class="font-size12">
                    And, if you are new to OrangeGubbi.com
                </p>

                <p>
                    <a href="#" id="new_reg">Create a new Account</a> - It’s Free!
                </p>
            </div>
        </div>
        <% } %>

    </div>

    <div class="userpop-footer align-center">
        <p class="font-size10">
            <a href="#">Terms of use</a>|
            <a href="#">Privacy Policy</a>
        </p>
        <p class="font-size9">
            &copy; 2015 MyGubbi.com All rights reserved
        </p>
    </div>

    <div class="close-icon" onclick="closePopup('.userpop');">
        <img src="img/close-white.png">
    </div>

</div>
<!-- User PopUp End -->

<!-- Forgot Password Modal -->
<div id="forgot_password" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content signup">
            <h2>Forgot Password</h2>
            <div class="row">
                <div class="margin-bottom20">
                    <p class="margin0">Enter your registered email Id</p>
                    <input type="text" class="width100" placeholder="abc@xyz.com"/>
                </div>
                <div class="padding20-0 align-center" id="reset_password">
                    <a
                        href="#"
                        class="button margin-top20 margin-bottom20">
                        reset password
                    </a>
                </div>
            </div>
            <p class="modal_success_msg">We have sent a link to your registered mail id.</p>
            <p class="modal_success_msg">Please follow the link to change your password.</p>
            <p class="modal_error_msg">Email Id not registered.</p>
            <p class="modal_error_msg">Please enter correct email id or try creating a new account.</p>
            <div class="close-icon signup-form" onclick="closeModal('#forgot_password');">
                <img src="img/close-white.png">
            </div>
        </div>

    </div>
</div>
<!-- Forgot Password Modal End -->

<!-- SignUp Modal -->
<div id="signup" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content signup">
            <h2>
                <img src="img/user.png">
                Create a new Account
            </h2>

            <div class="row display-none" id="reg_error_row">
                <p class="margin0 error-text align-center" id="reg_error"></p>
            </div>

            <form id="registerForm" data-toggle="validator" role="form">
                <div class="row">
                    <div class="margin-bottom20 form-group">
                        <p class="margin0">Full Name*</p>
                        <input type="text" class="width100 form-control" placeholder="John Doe" id="reg_full_name" required/>
                        <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                        <div class="help-block with-errors"></div>
                    </div>
                    <div class="margin-bottom20 form-group has-feedback">
                        <p class="margin0">Contact Number</p>
                        <input type="number" class="width100 form-control" placeholder="9876543210 or 8076543210" id="reg_contact_num" data-minlength="10" maxlength="10"/>
                        <div class="help-block with-errors"></div>
                    </div>
                    <div class="margin-bottom20 form-group">
                        <p class="margin0">Email ID*</p>
                        <input type="email" class="width100 form-control" placeholder="abc@xyz.com" id="reg_email_id" required pattern=".+@.+\..+" title="<abc>@<xyz>.<com>"/>
                        <div class="help-block with-errors"></div>
                    </div>
                    <div class="form-group">
                        <div class="margin-bottom20 form-group">
                            <p class="margin0">Password*</p>
                            <input type="password" data-minlength="6" class="width100 form-control" id="reg_password" pattern=".{6,}"
                                   required/>
                            <span class="help-block">Minimum of 6 characters</span>
                        </div>
                        <div class="margin-bottom20 form-group">
                            <p class="margin0">Confirm Password*</p>
                            <input type="password" id="reg_confirm" class="width100 form-control"
                                   data-match="#reg_password" data-match-error="Whoops, these don't match" required/>
                            <div id="reg_confirm_error" class="help-block with-errors"></div>
                        </div>
                    </div>
                    <div class="align-center form-group">
                        <button
                                id="signup-btn"
                                class="button margin-top20 margin-bottom20"
                                style="background: transparent" type="submit"
                                data-loading-text="<i class='fa fa-spinner fa-spin'></i> sign up">
                            sign up
                        </button>
                    </div>
                </div>
            </form>
            <div class="close-icon signup-form" onclick="closeModal('#signup');">
                <img src="img/close-white.png">
            </div>
        </div>

    </div>
</div>
<!-- SignUp Modal End -->

<!-- Notification Modal -->
<div id="notify" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content signup">
            <p class="margin0" id="reg_done_message"></p>
        </div>
    </div>
</div>
<!-- Notification End -->

<!-- Search Overlay -->

<div class="search_overlay" autocomplete="off" action="#">
    <div class="search_logo">
        <img src="img/gubbi_white.png" alt="MyGubbi">
    </div>
    <div class="search_close"></div>
    <div class="row">
        <span class="search_info">Just type and press 'enter'</span>
    </div>
    <div class="row align-center">
        <input type="text" class="search_input"/>
    </div>
    <% if(typeof(a_srch) !== 'undefined' && ((Object.keys(a_srch).length) !== 0)) { %>
        <div class="row search_suggest">
            <%  _.each(a_srch, function(as){
                if(as && as.resultName){ %>
                    <a href="#"><p><%= as.resultName %></p></a>
            <% } }); %>
        </div>
    <% } %>
    <% if(typeof(p_srch) !== 'undefined' && ((Object.keys(p_srch).length) !== 0)) {
         if(typeof(p_srch.popularSearches) !== 'undefined'){ %>
        <div class="row margin-top5per">
                <div class="col-md-4">
                    <div class="search_heading">Popular Searches..</div>
                    <div class="search_data" id="pop_search">
                        <%  _.each(p_srch.popularSearches, function(ps){
                            if(typeof(ps.name) !== 'undefined'){ %>
                            <a href="#"><p><%= ps.name %></p></a>
                        <% } }); %>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="search_heading">Recent Searches..</div>
                    <div class="search_data" id="rec_search">
                        <% _.each(p_srch.recentSearches, function(rs){
                            if(typeof(rs.name) !== 'undefined'){ %>
                            <a href="#"><p><%= rs.name %></p></a>
                        <% } }); %>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="search_heading">My Searches..</div>
                    <div class="search_data" id="my_search">
                        <% _.each(p_srch.mySearches, function(ms){
                            if(typeof(ms.name) !== 'undefined'){ %>
                                <a href="#"><p><%= ms.name %></p></a>
                        <% } }); %>
                    </div>
                </div>
            </div>
    <% } } %>
</div>

<!-- Search Overlay End -->


<script>

    var ref = new Firebase(firebaseBase);

    function createUser(userId, data, cbk) {
        ref.child("users").child(userId).set(data, function(error) {
            if (error) {
                console.log("Data could not be saved." + error);
                cbk(false);
            } else {
                console.log("Data saved successfully.");
                cbk(true);
            }
        });
    }

    function setUser(user) {
        users.add(user, {at: 0});
    }

    function getUserProfile(uid, authData, handleAuth) {
        var userProfileRef = new Firebase(firebaseBase + "user-profiles/" + uid);
        var userProfile = null;
        userProfileRef.once("value", function(snapshot) {
            if (snapshot.exists()) {
                userProfile = snapshot.val();
            }
            handleAuth(authData, userProfile);
            console.log("handleAuth done");
        });
    }

    var onFAuth = function (authData) {
      if (authData) {
        $('#user-icon').toggleClass("glyphicon glyphicon-user fa fa-spinner fa-spin");
        if (users.length === 0 || users.at(0).get('uid') !== authData.uid) {
            getUserProfile(authData.uid, authData, handleAuth);
            console.log("user profile done");
        }
      }
    };

    ref.onAuth(onFAuth);

    function handleAuth(authData, userProfile) {
        var user = {
            provider: authData.provider,
            email: getEmail(authData),
            displayName: getName(authData, userProfile),
            profileImage: getImage(authData, userProfile),
            uid: authData.uid
        };

        if (authData.provider !== 'password') {
            var userRef = new Firebase(firebaseBase + "users/" + authData.uid);
            userRef.once("value", function(snapshot) {
                if (snapshot.exists()) {
                    setUser(user);
                    console.log("user already exists in firebase");
                    window.fbButton && window.fbButton.button('reset');
                    window.googleButton && window.googleButton.button('reset');
                    $('#user-icon').toggleClass("glyphicon glyphicon-user fa fa-spinner fa-spin");
                } else {
                    console.log("user doesn't exist in firebase, creating..");

                    var cbk = function(result) {
                        if (result) {
                            setUser(user);
                            createProfile(authData, {
                                displayName : user.displayName,
                                phone : '',
                                profileImage: user.profileImage
                            }, null);
                        }
                        window.fbButton && window.fbButton.button('reset');
                        window.googleButton && window.googleButton.button('reset');
                        $('#user-icon').toggleClass("glyphicon glyphicon-user fa fa-spinner fa-spin");
                    };
                    createUser(authData.uid, user, cbk);
                }
            });
        } else {
            setUser(user);
            $('#user-icon').toggleClass("glyphicon glyphicon-user fa fa-spinner fa-spin");
        }
    }

    function authHandler(error, authData) {
        if (error) {
            console.log("Login Failed!", error);
            $('#login_error').html(error);
            $('#login_error_row').css("display", "block");
        } else {
            console.log("Authenticated successfully");
        }
        window.loginButton && window.loginButton.button('reset');
    }

    function pwdLogin() {
        ref.authWithPassword({
            email    : $('#emailId').val(),
            password : $('#pwd').val()
        }, authHandler, {remember: $('#remember').is(':checked') ? 'default' : 'sessionOnly'});
    }

    function signOut() {
        ref.unauth();
        users.reset();
    }

    function getName(authData, userProfile) {
      if (userProfile) {
        return userProfile.displayName;
      } else {
          switch(authData.provider) {
             case 'password':
               return authData.password.email.replace(/@.*/, '');
             case 'google':
               return authData.google.displayName;
             case 'facebook':
               return authData.facebook.displayName;
          }
      }
    }

    function getImage(authData, userProfile) {
      if (userProfile) {
        return userProfile.profileImage;
      } else {
          switch(authData.provider) {
             case 'password':
               return authData.password.profileImageURL;
             case 'google':
               return authData.google.profileImageURL;
             case 'facebook':
               return authData.facebook.profileImageURL;
          }
      }
    }

    function getEmail(authData) {
      switch(authData.provider) {
         case 'password':
           return authData.password.email;
         case 'google':
           return authData.google.email;
         case 'facebook':
           return authData.facebook.email;
      }
    }

    function closeModal(id) {
        $(id).modal('toggle');
    }

    function closePopup(id) {
        $(id).hide();
    }

    $(document).ready(function() {
        $('.user').click(function() {
            $('.userpop').show();
        });

        $('#new_reg').click(function() {
            $('.userpop').hide();
            $('#signup').modal('toggle');
            $('#reg_error').html('');
            $('#reg_error_row').css("display", "none");
            $('#reg_password').val('');
            $('#reg_confirm').val('');

        });

        $("#registerForm").submit(function(e) {
            e.preventDefault();
            if ($('#reg_confirm').val() !== $('#reg_password').val()) {
                $('#reg_confirm_error').html("Passwords don't match!");
            } else {
                window.signupButton.button('loading');
                $('#reg_confirm_error').html('');
                $('#reg_error').html('');
                $('#reg_error_row').css("display", "none");
                signUp();
            }
        });

        $('#loginBtn').click(function() {
            window.loginButton = $(this);
        });

        $('#signup-btn').click(function() {
            window.signupButton = $(this);
        });

        $("#loginForm").submit(function(e) {
            e.preventDefault();
            window.loginButton.button('loading');
            $('#login_error').html('');
            $('#login_error_row').css("display", "none");
            pwdLogin();
        });

        /*$("#signup").on('hidden.bs.modal', function () {
            $('#notify').modal('toggle');
        });*/

        $('.search').click(function() {
            $('.search_overlay').slideDown();
            $('.search_input').focus();
        });

        $('.search_close').click(function() {
            $('.search_overlay').slideUp();
        });

        $('.search_input').keyup(function() {
            var char = $(this).val().length;
            if(char >= 3){
                $('.search_suggest').slideDown();
            } else {
                $('.search_suggest').slideUp();
            }
        });

        $('.search_overlay').click(function() {
            $('.search_input').focus();
            $('.search_suggest').slideUp();
        });

        $('#reset_password').click(function() {
            $('.modal_success_msg').slideDown();
            $('.modal_error_msg').slideDown();
        });

        $("#forgot_password").on('hidden.bs.modal', function () {
            $('.modal_success_msg').css('display','none');
            $('.modal_error_msg').css('display','none');
        });

        $('#fb-btn').click(function() {
            window.fbButton = $(this);
            window.fbButton.button('loading');
            ref.authWithOAuthPopup("facebook", authHandler);
        });

        $('#google-btn').click(function() {
            window.googleButton = $(this);
            window.googleButton.button('loading');
            ref.authWithOAuthPopup("google", authHandler);
        });

        $('[data-toggle="tooltip"]').tooltip();

    });


    function signUp() {

        ref.createUser({
            email    : $('#reg_email_id').val(),
            password : $('#reg_password').val()
        }, function(error, userData) {
            if (error) {
                console.log("Error creating user:", error);
                $('#reg_error').html(error);
                $('#reg_error_row').css("display", "block");
                window.signupButton.button('reset');
            } else {
                console.log("Successfully created user account with uid:", userData.uid);
                ref.offAuth(onFAuth);
                ref.authWithPassword({
                    email    : $('#reg_email_id').val(),
                    password : $('#reg_password').val()
                }, function(error, authData) {

                    var profileData = {
                        displayName : $('#reg_full_name').val(),
                        phone : $('#reg_contact_num').val(),
                        profileImage: authData.password.profileImageURL
                    };

                    var callbk = function() {
                        ref.unauth();
                        window.signupButton.button('reset');
                        $('#reg_done_message').html("Thanks for registering with us. You now have access to our personalized service. Please <a href='#' onclick='gotoLogin();'>Login</a> to proceed.");
                        $('#signup').modal('toggle');
                        $('#notify').modal('show');
                        ref.onAuth(onFAuth);
                    };

                    createProfile(userData, profileData, callbk);

                });
            }
        });

        return false;
    }

    function gotoLogin() {
        $('#notify').modal('toggle');
        $('.userpop').show();
    }

    function createProfile(userData, profileData, cbk) {
        ref.child('user-profiles').child(userData.uid).set(
            profileData
            , function(error) {
                if (error) {
                    console.log("password profile data could not be saved." + error);
                } else {
                    console.log("data saved successfully.");
                }
                if (cbk) cbk();
            });
    }

</script>
